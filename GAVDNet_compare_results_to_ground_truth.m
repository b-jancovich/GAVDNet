%% GAVDNet Compare Detector Results with GroundTruth
%
% This script is designed to calculate performance metrics for the GAVDNet
% animal call detector, by comparing the outputs of the 
% "GAVDNet_Run_Detector.m" script for a given audio dataset, with a trusted 
% list of date-time stamped detections for that same audio dataset. The
% comparison is handled by the "compareDetectionsToSubsampledTestDataset()"
% function, which uses Hungarian algorithm via matchpairs to match detector
% results with their corresponding groundtruth detections.
%
% Groundtruth for audio recorded on the CTBTO's IMS system is stored in a
% .mat file in a custom format, and was generated by Dr. Emanuelle Leroy 
% in [1]. The groundtruth for audio recorded as part of the Antarctic Blue 
% and Fin Whale Acoustic Trends Project by the International Whaling 
% Commission's Southern Ocean Research Partnership (SORP) is stored as a 
% .txt file in the Raven Selection Table Format (Cornell Lab Of Ornithology)
% and was made publicly available as part of [2]. 
%
% This script can handle both CTBTO and SORP data. Modify the value of 
% the variable "gtFormat" accordingly.
%
% References:
%   [1] Leroy, Emmanuelle C., Jean-Yves Royer, Abigail Alling, Ben Maslen, 
%   and Tracey L. Rogers. “Multiple Pygmy Blue Whale Acoustic Populations 
%   in the Indian Ocean: Whale Song Identifies a Possible New Population.” 
%   Scientific Reports 11, no. 1 (December 2021): 8762. 
%   https://doi.org/10.1038/s41598-021-88062-5.
%
%   [2] Miller, Brian S., Naysa Balcazar, Sharon Nieukirk, Emmanuelle C. 
%   Leroy, Meghan Aulich, Fannie W. Shabangu, Robert P. Dziak, Won 
%   Sang Lee, and Jong Kuk Hong. “An Open Access Dataset for Developing 
%   Automated Detectors of Antarctic Baleen Whale Sounds and Performance 
%   Evaluation of Two Commonly Used Detectors.” Scientific Reports 11 
%   (January 12, 2021): 806. https://doi.org/10.1038/s41598-020-78995-8.
%
%
% Ben Jancovich, 2025
% Centre for Marine Science and Innovation
% School of Biological, Earth and Environmental Sciences
% University of New South Wales, Sydney, Australia
% 
%% Init

clear
close all
clc
clear persistent

%% **** USER INPUT ****

% Path to the config file:
% configPath = "C:\Users\z5439673\Git\GAVDNet\GAVDNet_config_DGS_chagos.m";
configPath = "C:\Users\z5439673\Git\GAVDNet\GAVDNet_config_SORP_BmAntZ.m";

% Path to detector results file (postprocessed):
% many_inferenceResultsPaths{1} = "D:\GAVDNet\Chagos_DGS\Test Results\Final Test - 2007subset\-10 to 10 Single Exemplar\detector_results_postprocessed.mat";
% many_inferenceResultsPaths{2} = "D:\GAVDNet\Chagos_DGS\Test Results\Final Test - 2007subset\-10 to 10\detector_results_postprocessed.mat";
% many_inferenceResultsPaths{3} = "D:\GAVDNet\Chagos_DGS\Test Results\Final Test - 2007subset\-6 to 10\detector_results_postprocessed.mat";
% many_inferenceResultsPaths{4} = "D:\GAVDNet\Chagos_DGS\Test Results\Final Test - 2007subset\-3 to 10\detector_results_postprocessed.mat";

many_inferenceResultsPaths{1} = "D:\GAVDNet\BmAntZ_SORP\Test Results\Final Test - Casey2014\-10 to 10 Single Exemplar\detector_results_postprocessed.mat";
many_inferenceResultsPaths{2} = "D:\GAVDNet\BmAntZ_SORP\Test Results\Final Test - Casey2014\-10 to 10\detector_results_postprocessed.mat";
many_inferenceResultsPaths{3} = "D:\GAVDNet\BmAntZ_SORP\Test Results\Final Test - Casey2014\-6 to 10\detector_results_postprocessed.mat";
many_inferenceResultsPaths{4} = "D:\GAVDNet\BmAntZ_SORP\Test Results\Final Test - Casey2014\-3 to 10\detector_results_postprocessed.mat";

% Different output paths for each version of the detector we are testing:
% many_gavdNetDataPaths{1} = "D:\GAVDNet\Chagos_DGS\Training & Models\-10 to 10 Single Exemplar";
% many_gavdNetDataPaths{2} = "D:\GAVDNet\Chagos_DGS\Training & Models\-10 to 10";
% many_gavdNetDataPaths{3} = "D:\GAVDNet\Chagos_DGS\Training & Models\-6 to 10";
% many_gavdNetDataPaths{4} = "D:\GAVDNet\Chagos_DGS\Training & Models\-3 to 10";

many_gavdNetDataPaths{1} = "D:\GAVDNet\BmAntZ_SORP\Training & Models\-10 to 10 Single Exemplar";
many_gavdNetDataPaths{2} = "D:\GAVDNet\BmAntZ_SORP\Training & Models\-10 to 10";
many_gavdNetDataPaths{3} = "D:\GAVDNet\BmAntZ_SORP\Training & Models\-6 to 10";
many_gavdNetDataPaths{4} = "D:\GAVDNet\BmAntZ_SORP\Training & Models\-3 to 10";

% Path to "groundtruth" file containing date and time stamps of the true 
% detections of the target call in the test audio files:
% groundtruthPath = "D:\GAVDNet\Chagos_DGS\Test Data\2007subset\test_dataset_detection_list.mat";
groundtruthPath = "C:\Users\z5439673\OneDrive - UNSW\Documents\Detector Test Datasets\AAD_AcousticTrends_BlueFinLibrary\DATA\casey2014\Casey2014.Bm.Ant-Z.selections.txt";

% Test dataset source
gtFormat = 'SORP'; % Either "CTBTO" or "SORP" 
% CTBTO for Chagos, SORP for Z-call

% True known call duration (for isolating audio for missed detections)
maxDetectionDuration = 40; % (seconds)
% NOT the max duration of the calls in the training data, as these may not
% contain the entire song, but the maximum duration of the real song, as
% observed in real recordings.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% NO MORE USER TUNABLE PARAMETERS. DO NOT MODIFY THE CODE BELOW THIS POINT.


for modelNum = 1:length(many_inferenceResultsPaths)

%% Set Paths and Load Input Variables

    % Add dependencies to path
    run(configPath) % Load config file
    projectRoot = pwd;
    [gitRoot, ~, ~] = fileparts(projectRoot);
    addpath(fullfile(projectRoot, "Functions"))

    inferenceResultsPath = many_inferenceResultsPaths{modelNum};
    gavdNetDataPath = many_gavdNetDataPaths{modelNum};

    % Set output path
    [gtCompareResultsPath, ~, ~] = fileparts(inferenceResultsPath);
    gtCompareResultsPath = fullfile(gtCompareResultsPath, "groundtruthComparisonResults.xlsx");
    
    %% Load model
    
    % Handle multiple model files with a UI dialog:
    modelList = dir(fullfile(gavdNetDataPath, 'GAVDNet_trained_*'));
    if isscalar(modelList)
        load(fullfile(modelList.folder, modelList.name))
        fprintf('Loading model: %s\n', modelList.name)
        [~, modelName, ~] = fileparts(fullfile(modelList.folder, modelList.name));
    
    else
        [file, location] = uigetfile(gavdNetDataPath, 'Select a model to load:');
        load(fullfile(location, file))
        [~, modelName, ~] = fileparts(fullfile(location, file));
    end
    
    % Re-load the postprocessor parameters used at inference:
    load(inferenceResultsPath, "postProcOptions")
    
    % Reload the feature framing mode used at inference:
    load(inferenceResultsPath, "featureFraming");
    
    %% Compare Detector Output to Groundtruth
    
    % Run groundtruth comparison
    [metrics, FP, FN] = compareDetectionsToSubsampledTestDataset(...
        groundtruthPath, inferenceResultsPath, detectionTolerance, maxDetectionDuration, gtFormat);
    
    %% Save Results
    
    % Compile results and test params
    testCompleteTime = string(datetime("now", "Format", "dd-MMM-uuuu_HH-mm-ss"));
    [~, dataSetName, ~] = fileparts(fileparts(groundtruthPath));
    
    confDist = metrics.confidenceDistribution;
    confPercentile1 = confDist.confPercentiles(1);
    confPercentile50 = confDist.confPercentiles(5);
    confPercentile99 = confDist.confPercentiles(9);
    
    outTable = struct2table(metrics);
    outTable = removevars(outTable, {'temperatureScaling', 'roc', 'performanceCurve', ...
        'evaluatedResultCount', 'numResultsExcluded_NoScoreOrTime',...
        'groundtruthSource', 'numResultsExcluded_InferenceFailures',...
        'matchingAlgorithm', 'totalAudioDuration_sec', 'confidenceDistribution',...
        'detectionTolerance_sec', 'sensitivity'});
    newNames = {'1stPrctileConf', '50thPrctileConf', '99thPrctileConf', ...
        'ActivationThreshold', 'DeactivationThreshold', 'AEAVD', ...
        'MergeThreshold', 'LengthThresholdScaler', 'LengthThreshold', ...
        'TestTimeStamp', 'ModelName', 'TestDataset', 'SequenceSNRRange',...
        'FeatureFramingMode', 'FrameStandardization'};
    outTable = addvars(outTable, confPercentile1, confPercentile50, ...
        confPercentile99, postProcOptions.AT, postProcOptions.DT, ...
        postProcOptions.AEAVD, postProcOptions.MT, postProcOptions.LT_scaler, ...
        postProcOptions.LT, testCompleteTime, string(modelName), dataSetName,...
        model.dataSynthesisParams.snrRange,...
        string(featureFraming), string(frameStandardization), 'NewVariableNames', newNames);
    
    % Write output to CSV
    if exist(gtCompareResultsPath, 'file') == 2
        % Append data without headers
        writetable(outTable, gtCompareResultsPath, 'WriteMode', 'append', 'WriteVariableNames', false);
    else
        % File does not exist — write with headers
        writetable(outTable, gtCompareResultsPath);
    end
    
    % Save disagreements
    disagreements = struct('falsePositives', FP, 'falseNegatives', FN);
    [resultsFolder, ~, ~] = fileparts(gtCompareResultsPath);
    saveNamePath = fullfile(resultsFolder,...
        strcat('detector_vs_GT_disagreements_', testCompleteTime, '.mat'));
    save(saveNamePath, 'disagreements', '-v7.3')

    clearvars -except configPath many_inferenceResultsPaths maxDetectionDuration gtFormat groundtruthPath many_gavdNetDataPaths
    clear persistent
end